const userInput = document.getElementById('user-input');    
const sendBtn = document.getElementById('send-btn');    

function addMessage(text, isUser) {    
    const div = document.createElement('div');    
    div.className = `message ${isUser ? 'user-message' : 'bot-message'}`;    
    div.textContent = text;    
    chatMessages.appendChild(div);    
    chatMessages.scrollTop = chatMessages.scrollHeight;    
}    

async function getTherapistResponse(message) {    
    addMessage(message, true);    
    userInput.value = '';    

    try {    
        const res = await fetch('https://api.openai.com/v1/chat/completions', {    
            method: 'POST',    
            headers: {    
                'Content-Type': 'application/json',    
                'Authorization': `Bearer ${apiKey}`    
            },    
            body: JSON.stringify({    
                model: 'gpt-4o-mini',               // reliable, cost‑effective model    
                temperature: 0.7,    
                messages: [    
                    { role: 'system', content: `You are "The Therapist", an empathetic AI that uses psychological principles to help users manage emotions, solve everyday problems, and give relationship advice. Target audiences: couples, students, business professionals. Be supportive, concise, and practical.` },    
                    { role: 'user', content: message }    
                ]    
            })    
        });    

        const data = await res.json();    
        const reply = data.choices?.[0]?.message?.content?.trim() || 'Sorry, I couldn’t generate a response.';    
        addMessage(reply, false);    
    } catch (err) {    
        console.error(err);    
        addMessage('Error: Unable to reach the server. Please try again later.', false);    
    }    
}    

sendBtn.addEventListener('click', () => {    
    const txt = userInput.value.trim();    
    if (txt) getTherapistResponse(txt);    
});    

userInput.addEventListener('keydown', e => {    
    if (e.key === 'Enter') sendBtn.click();    
});

</script>


<!-- Google Fonts + Material Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
  #access-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #007bff, #00c6ff);
    color: white;
    border: none;
    border-radius: 50%;
    width: 70px;
    height: 70px;
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    cursor: grab;
    z-index: 9999;
  }

  #paymentModal {
    font-family: 'Poppins', sans-serif;
  }

  .modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  .modal-header {
    background: linear-gradient(135deg, #007bff, #00c6ff);
    color: white;
    border-bottom: none;
  }

  .copy-btn {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 5px 10px;
    margin-top: 10px;
  }

  .alert-info {
    background: #e7f1ff;
    border: 1px solid #007bff;
    color: #004085;
    border-radius: 10px;
    padding: 10px;
    margin-top: 15px;
    font-size: 14px;
  }
</style>

<!-- Floating Access Button -->
<button id="access-btn" title="Subscription Access">
  <span class="material-icons">account_circle</span>
</button>

<!-- Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="paymentModalLabel">Access Subscription</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="step1">
          <h6>Register Your Account</h6>
          <input id="fullname" class="form-control mt-2" placeholder="Full Name">
          <input id="email" type="email" class="form-control mt-2" placeholder="Email">
          <input id="password" type="password" class="form-control mt-2" placeholder="Choose Password">
          <button id="toStep2" class="btn btn-primary w-100 mt-3">Next</button>
        </div>

        <div id="step2" style="display:none;">
          <h6>Select Subscription</h6>
          <select id="plan" class="form-select mt-2">
            <option value="2500">₦2,500 - 1 Week</option>
            <option value="5000">₦5,000 - 1 Month</option>
            <option value="25000">₦25,000 - 1 Year</option>
          </select>
          <button id="toStep3" class="btn btn-primary w-100 mt-3">Continue</button>
        </div>

        <div id="step3" style="display:none;">
          <h6>Payment Details</h6>
          <p><strong>Bank:</strong> Opay<br>
             <strong>Account Name:</strong> Oneuegbusi Amaechi Daniel<br>
             <strong>Account Number:</strong> <span id="accountNo">8106235912</span>
             <button class="copy-btn" onclick="copyAccount()">Copy</button>
          </p>
          <div class="alert-info">
            Please only click “I’ve Paid” if you have paid already.
          </div>
          <button id="paidBtn" class="btn btn-success w-100 mt-3">I’ve Paid</button>
        </div>

        <div id="waiting" style="display:none; text-align:center;">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-3">Waiting for admin approval...</p>
        </div>

        <div id="approved" style="display:none; text-align:center;">
          <i class="material-icons" style="font-size:50px;color:green;">check_circle</i>
          <h5 class="mt-3">Approved!</h5>
          <p>You now have full access to this page.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/+esm';

  const SUPABASE_URL = 'https://pjedtymwfyjmzluejygs.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqZWR0eW13ZnlqbXpsdWVqeWdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjE4OTYsImV4cCI6MjA3NjAzNzg5Nn0.g7p_nlemO1ZvpGMPwutsnr2SmlE4jVZw-VCGsbQK530';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ========== Memory & Modal Flow ========== */
  const steps = ["step1","step2","step3","waiting","approved"];
  const storage = localStorage;
  const modalEl = document.getElementById('paymentModal');
  const modal = new bootstrap.Modal(modalEl, {
    backdrop: 'static',
    keyboard: false
  });
  modalEl.querySelector('.btn-close').style.display = 'none';

  function showStep(step){
    steps.forEach(s=>document.getElementById(s).style.display='none');
    document.getElementById(step).style.display='block';
  }

  function saveProgress(stage){ storage.setItem('stage', stage); }
  function loadProgress(){ return storage.getItem('stage') || 'step1'; }

  function copyAccount(){
    navigator.clipboard.writeText(document.getElementById('accountNo').innerText);
    alert('Account number copied!');
  }

  function restoreForm(){
    ['fullname','email','phone','password','plan'].forEach(key=>{
      const val = storage.getItem(key);
      if(val){
        const el = document.getElementById(key);
        if(el) el.value = val;
      }
    });
    const plan = storage.getItem('plan');
    if(plan){
      const radio = document.querySelector(`input[name="plan"][value="${plan}"]`);
      if(radio) radio.checked = true;
    }
  }

  // Steps control
  document.getElementById('toStep2').onclick=()=>{
    const fullname = document.getElementById('fullname').value.trim();
    const email    = document.getElementById('email').value.trim();
    const phone    = document.getElementById('phone').value.trim();
    const password = document.getElementById('password').value;
    if(!fullname || !email || !phone || !password) return alert('All fields are required');
    storage.setItem('fullname', fullname);
    storage.setItem('email', email);
    storage.setItem('phone', phone);
    storage.setItem('password', password);
    showStep('step2'); saveProgress('step2');
  };

  document.getElementById('toStep3').onclick=()=>{
    const plan = document.querySelector('input[name="plan"]:checked').value;
    storage.setItem('plan', plan);
    showStep('step3'); saveProgress('step3');
  };

  document.getElementById('paidBtn').onclick=async ()=>{
    const userData = {
      fullname: storage.getItem('fullname'),
      email: storage.getItem('email'),
      phone: storage.getItem('phone'),
      plan: storage.getItem('plan'),
      amount: storage.getItem('plan') === 'basic' ? 5000 : storage.getItem('plan') === 'pro' ? 12000 : 20000,
      status: 'pending'
    };

    const { error } = await supabase
      .from('payments')
      .insert([userData]);

    if(error){
      alert('Submission failed: ' + error.message);
      return;
    }

    showStep('waiting');
    saveProgress('waiting');
    alert('Payment reported. Waiting for admin approval...');
    startPolling();
  };

  async function startPolling(){
    const email = storage.getItem('email');
    const interval = setInterval(async ()=>{
      const { data, error } = await supabase
        .from('payments')
        .select('status')
        .eq('email', email)
        .eq('status', 'approved')
        .single();

      if(data){
        clearInterval(interval);
        approveUser();
      }
    }, 5000);
  }

  function approveUser(){
    showStep('approved');
    saveProgress('approved');
    modal.hide();
    document.getElementById('access-lock').remove();
    alert('Admin has approved your access!');
  }

  window.addEventListener('load', async ()=>{
    restoreForm();
    const stage = loadProgress();

    if(stage === 'approved'){
      modal.hide();
      const lock = document.getElementById('access-lock');
      if(lock) lock.remove();
    } else {
      showStep(stage);
      modal.show();
      if(stage === 'waiting') startPolling();
    }

    const btn = document.getElementById('access-btn');
    if(storage.getItem('btnX')) btn.style.left = storage.getItem('btnX');
    if(storage.getItem('btnY')) btn.style.top  = storage.getItem('btnY');
  });

  /* ========== Floating Button Logic (Top-Right) ========== */
  const btn = document.getElementById('access-btn');
  let offsetX, offsetY, isDragging=false;
  btn.addEventListener('mousedown', e=>{
    isDragging=true;
    offsetX = e.clientX - btn.getBoundingClientRect().left;
    offsetY = e.clientY - btn.getBoundingClientRect().top;
  });
  document.addEventListener('mousemove', e=>{
    if(!isDragging) return;
    btn.style.left = (e.clientX - offsetX) + 'px';
    btn.style.top  = (e.clientY - offsetY) + 'px';
  });
  document.addEventListener('mouseup', ()=>isDragging=false);

  window.addEventListener('beforeunload',()=>{
    storage.setItem('btnX', btn.style.left);
    storage.setItem('btnY', btn.style.top);
  });

  btn.onclick = () => {
    if(loadProgress() !== 'approved') modal.show();
  };

  // Auto-open after 1 minute (60,000 ms)
  setTimeout(()=>{
    if(loadProgress() !== 'approved') modal.show();
  }, 120000);
</script>
  </body>

</html>    


